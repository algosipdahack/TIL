### Transactional Outbox Pattern
- 메시지를 DB 트랜잭션과 묶어서 커밋하여 비동기적으로 메시지 브로커에게 전달하는 패턴

#### 문제상황
- DB 수정과 관련된 SQL을 Event로 전달 -> 트랜잭션이 완료되기 전에 이벤트 메시지를 발행 -> 비즈니스 로직에서 예외 or 특정이유로 예외발생하여 롤백가능
  - 트랜잭션이 성공하지 않았는데 메시지 발행 가능
- DB 업데이트와 메시지 전송을 하나의 트랜잭션으로 묶지 않을 시 문제 발생

### 해결책
- 2PC(two-phase commit)
  - 두 개 이상의 자원(DB, Message Broker)를 한 트랜잭션으로 처리하는 방법
  - 1단계에서 각 노드에 prepare요청을 보내서 커밋을 할 수 있는지 여부를 확인
    - 하나라도 실패/타임아웃 시 모든 참여자들에게 abort요청
  - 2단계에서 커밋요청을 수행
  - 단점
    - 성능이슈 -> 단일 DB의 10배
    - 동기 IPC 형태이기에 가용성이 떨어짐

- Transaction Outbox Pattern
  - DB를 업데이트하는 트랜잭션의 일부로 DB에 메시지를 저장하는 방법 -> 별도의 프로세스가 저장된 이벤트를 읽어 메시지 브로커에 전송
  - 과정
    - DB의 outbox테이블에 메시지 내용을 저장
    - 다른 프로세스는 outbox 테이블에서 데이터를 읽고 해당 데이터를 사용하여 작업을 수행
    - 실패 시 완료때까지 다시 시도
    - 따라서 적어도 한번 이상 메시지가 성공적으로 전송되었는지 확인 가능
  - outbox
    - 보낼 편지함
      - 전송되지 않았거나 전송에 실패한 메시지들이 모여있는 보관함


### Reference
---
https://velog.io/@eastperson/Transaction-Outbox-Pattern-%EC%95%8C%EC%95%84%EB%B3%B4%EA%B8%B0